desc: Test uzumibi new command with webworker template
runners:
  cc:
    addr: chrome://new
    flags:
      window-size: "800,600"
      no-sandbox: true
      # headless: false # if you want to debug
vars:
  binary: ${UZUMIBI_TEST_BINARY:-../target/release/uzumibi}
  tmpdir: ${UZUMIBI_TEST_TMPDIR:-../tmp}
  project_name: test-webworker-project
  template: webworker
steps:
  build:
    desc: Build release binary
    exec:
      command: cargo build --release --quiet
    test: current.exit_code == 0

  setup_tmpdir:
    desc: Setup temp directory
    exec:
      command: mkdir -p {{ vars.tmpdir }}
    test: current.exit_code == 0

  cleanup_before:
    desc: Clean up existing test directory
    exec:
      command: rm -rf {{ vars.tmpdir }}/{{ vars.project_name }}
    test: current.exit_code == 0

  create_project:
    desc: Create new webworker project
    exec:
      command: cd {{ vars.tmpdir }} && {{ vars.binary }} new -t {{ vars.template }} {{ vars.project_name }}
    test: |
      current.exit_code == 0 &&
      current.stdout contains 'Successfully created project'

  check_cargo_toml:
    desc: Check Cargo.toml exists and has correct project name
    exec:
      command: cat {{ vars.tmpdir }}/{{ vars.project_name }}/Cargo.toml
    test: |
      current.exit_code == 0 &&
      current.stdout contains 'name = "test-webworker-project"'

  check_app_rb:
    desc: Check lib/app.rb exists
    exec:
      command: test -f {{ vars.tmpdir }}/{{ vars.project_name }}/lib/app.rb
    test: current.exit_code == 0

  check_index_html:
    desc: Check public/index.html exists
    exec:
      command: test -f {{ vars.tmpdir }}/{{ vars.project_name }}/public/index.html
    test: current.exit_code == 0

  build_wasm:
    desc: Build WebAssembly
    exec:
      command: cd {{ vars.tmpdir }}/{{ vars.project_name }} && make wasm
    test: current.exit_code == 0

  start_server:
    desc: Start dev server in background
    exec:
      command: cd {{ vars.tmpdir }}/{{ vars.project_name }} && make serve
      background: true

  wait_for_server:
    desc: Wait for server to start
    exec:
      command: for i in $(seq 1 300); do curl -s -o /dev/null http://127.0.0.1:8080 && exit 0; sleep 0.1; done; exit 1
    test: current.exit_code == 0

  test_browser_access:
    desc: Access page via CDP and verify web worker is ready
    cc:
      actions:
        - navigate: http://127.0.0.1:8080
        - waitVisible: '#worker-ready'
        - text: '#status'
    test: |
      current.text contains 'Web Worker ready!'

  test_uzumibi_access_via_fetch:
    desc: Fetch from worker and verify response
    cc:
      actions:
        - navigate: http://127.0.0.1:8080
        - waitVisible: '#worker-ready'
        - evaluate: |
            document.querySelector('#custom-path').value = '/';
        - click: '#btn-custom'
        - waitVisible: '#content pre'
        - text: '#content pre'
    test: |
      current.text contains 'It works!'

  cleanup_after:
    desc: Clean up test directory
    exec:
      command: rm -rf {{ vars.tmpdir }}/{{ vars.project_name }}
    test: current.exit_code == 0
