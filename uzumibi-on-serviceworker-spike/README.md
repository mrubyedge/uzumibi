# Service Worker Sample

A sample project for using WASM with Service Workers.

## File Structure

- `public/index.html`: Main HTML file. Registers the Service Worker and displays results.
- `public/service-worker.js`: Service Worker implementation. Loads WASM module and routes requests through it.
- `public/app.wasm`: Compiled WASM module (copied from build output).
- `lib/app.rb`: Ruby routing definition using Uzumibi framework.
- `src/lib.rs`: Rust code that initializes mruby VM and exports WASM functions.
- `build.rs`: Build script that compiles Ruby code to mruby bytecode.

## How It Works

1. Access `public/index.html`
2. JavaScript registers the Service Worker
3. Service Worker loads the WASM module (`app.wasm`)
4. User clicks a button to send a fetch request to `/`, `/hello`, or `/profile`
5. Service Worker intercepts the request, packs it into WASM memory format
6. WASM module (mruby runtime) executes the Ruby router code
7. Ruby code generates a response based on the route
8. Service Worker unpacks the response from WASM memory
9. Response is displayed on the page

## Building

### Using Make (Recommended)

```bash
make wasm
```

This will build the WASM module and copy it to the public directory.

Other available commands:
- `make build` - Build WASM module only
- `make copy` - Copy WASM to public directory only
- `make clean` - Clean build artifacts
- `make serve` - Start development server

### Manual Build

First, build the WASM module:

```bash
cargo build --target wasm32-unknown-unknown --release
```

Then copy the WASM file to the public directory:

```bash
cp ../target/wasm32-unknown-unknown/release/uzumibi_on_serviceworker_spike.wasm public/app.wasm
```

## Running

Service Workers only work over HTTPS or localhost. Start a local server:

### Using Make

```bash
make serve
```

### Using Python 3

```bash
python3 -m http.server 8000 -d public
```

### Using Node.js http-server

```bash
npx http-server public -p 8000
```

After starting the server, access `http://localhost:8000/` in your browser.

## Development

### Clearing Cache During Development

When developing and testing changes, you may need to unregister the Service Worker:

**How to unregister Service Worker**
1. Open Chrome DevTools
2. Go to **Application** tab
3. In the left sidebar, click **Service Workers** (under Application section)
4. Click **Unregister** next to your Service Worker
5. Reload the page

### Super Reload Behavior

**Note:** Super reload (Ctrl+Shift+R / Cmd+Shift+R) bypasses Service Workers by design. This is a browser feature that allows developers to bypass caching for testing.

**Automatic Recovery:** This application includes automatic super reload detection. If you accidentally perform a super reload:
1. The page detects that the Service Worker was bypassed
2. An alert is displayed to notify you
3. The page automatically reloads normally to re-activate the Service Worker

This detection works by checking:
- `navigator.serviceWorker.controller` is `null` (no active Service Worker)
- `performance.getEntriesByType('navigation')[0].type` is `'reload'`

If you want to intentionally clear caches during development, use the methods described above instead of super reload.

## Verification

1. Open browser developer tools
2. Check logs in the Console tab - you should see WASM debug messages
3. Check registration status in Application tab â†’ Service Workers
4. Click the buttons to make requests to different routes
5. Verify that responses are generated by the Ruby code running in WASM

## Next Steps

- Add POST request support
- Implement more complex routing patterns
- Add request body handling
- Optimize WASM module size
