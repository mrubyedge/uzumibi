desc: Test uzumibi new command with spin template
runners:
  req: http://127.0.0.1:3000
vars:
  binary: ${UZUMIBI_TEST_BINARY:-../target/release/uzumibi}
  tmpdir: ${UZUMIBI_TEST_TMPDIR:-../tmp}
  project_name: test-spin-project
  template: spin
steps:
  build:
    desc: Build release binary
    exec:
      command: cargo build --release --quiet
    test: current.exit_code == 0

  setup_tmpdir:
    desc: Setup temp directory
    exec:
      command: mkdir -p {{ vars.tmpdir }}
    test: current.exit_code == 0

  cleanup_before:
    desc: Clean up existing test directory
    exec:
      command: rm -rf {{ vars.tmpdir }}/{{ vars.project_name }}
    test: current.exit_code == 0

  create_project:
    desc: Create new spin project
    exec:
      command: cd {{ vars.tmpdir }} && {{ vars.binary }} new -t {{ vars.template }} {{ vars.project_name }}
    test: |
      current.exit_code == 0 &&
      current.stdout contains 'Successfully created project'

  check_cargo_toml:
    desc: Check Cargo.toml exists and has correct project name
    exec:
      command: cat {{ vars.tmpdir }}/{{ vars.project_name }}/Cargo.toml
    test: |
      current.exit_code == 0 &&
      current.stdout contains 'name = "test-spin-project"'

  check_app_rb:
    desc: Check lib/app.rb exists
    exec:
      command: test -f {{ vars.tmpdir }}/{{ vars.project_name }}/lib/app.rb
    test: current.exit_code == 0

  check_spin_toml:
    desc: Check spin.toml exists
    exec:
      command: test -f {{ vars.tmpdir }}/{{ vars.project_name }}/spin.toml
    test: current.exit_code == 0

  build_project:
    desc: Build the spin project
    exec:
      command: cd {{ vars.tmpdir }}/{{ vars.project_name }} && spin build
    test: current.exit_code == 0

  start_server:
    desc: Start spin server in background
    exec:
      command: cd {{ vars.tmpdir }}/{{ vars.project_name }} && spin up
      background: true

  wait_for_server:
    desc: Wait for server to start
    exec:
      command: for i in $(seq 1 300); do curl -s -o /dev/null http://127.0.0.1:3000 && exit 0; sleep 0.1; done; exit 1
    test: current.exit_code == 0

  test_root_request:
    desc: Send request to root path
    req:
      "/":
        get:
          body: null
    test: |
      current.res.status == 200 &&
      current.res.rawBody contains 'It works!'

  cleanup_after:
    desc: Clean up test directory
    exec:
      command: rm -rf {{ vars.tmpdir }}/{{ vars.project_name }}
    test: current.exit_code == 0
