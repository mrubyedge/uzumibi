# Web Worker Sample

A sample project for using WASM with Web Workers.

## File Structure

- `public/index.html`: Main HTML file. Initializes the Web Worker and overrides fetch().
- `public/worker.js`: Web Worker implementation. Loads WASM module and processes requests.
- `public/app.wasm`: Compiled WASM module (copied from build output).
- `lib/app.rb`: Ruby routing definition using Uzumibi framework.
- `src/lib.rs`: Rust code that initializes mruby VM and exports WASM functions.
- `build.rs`: Build script that compiles Ruby code to mruby bytecode.

## How It Works

1. Access `public/index.html`
2. JavaScript initializes the Web Worker
3. Web Worker loads the WASM module (`app.wasm`)
4. The main thread overrides `window.fetch()` to route requests through the Worker
5. User clicks a button to send a fetch request to `/`, `/hello`, or `/profile`
6. The overridden fetch() sends the request data to the Web Worker via postMessage
7. Web Worker packs the request into WASM memory format
8. WASM module (mruby runtime) executes the Ruby router code
9. Ruby code generates a response based on the route
10. Web Worker unpacks the response from WASM memory
11. Web Worker sends the response back to main thread via postMessage
12. The overridden fetch() creates a Response object and resolves the Promise
13. Response is displayed on the page

## Difference from Service Worker Version

| Aspect | Service Worker | Web Worker |
|--------|---------------|------------|
| Intercepts real fetch | Yes (via fetch event) | No (overrides window.fetch) |
| Works offline | Yes | No |
| Scope | All pages in scope | Single page |
| HTTPS required | Yes | No |
| Persistence | Installed in browser | Per-page lifecycle |

## Building

### Using Make (Recommended)

```bash
make wasm
```

This will build the WASM module and copy it to the public directory.

Other available commands:
- `make build` - Build WASM module only
- `make copy` - Copy WASM to public directory only
- `make clean` - Clean build artifacts
- `make serve` - Start development server

### Manual Build

First, build the WASM module:

```bash
cargo build --target wasm32-unknown-unknown --release
```

Then copy the WASM file to the public directory:

```bash
cp ../target/wasm32-unknown-unknown/release/uzumibi_on_webworker_spike.wasm public/app.wasm
```

## Running

Start a local server:

### Using Make

```bash
make serve
```

### Using Python 3

```bash
python3 -m http.server 8000 -d public
```

### Using Node.js http-server

```bash
npx http-server public -p 8000
```

After starting the server, access `http://localhost:8000/` in your browser.

## Verification

1. Open browser developer tools
2. Check logs in the Console tab - you should see WASM debug messages from the Worker
3. Click the buttons to make requests to different routes
4. Verify that responses are generated by the Ruby code running in WASM

## Next Steps

- Add POST request support with body handling
- Implement more complex routing patterns
- Add SharedArrayBuffer support for better performance
- Optimize WASM module size
