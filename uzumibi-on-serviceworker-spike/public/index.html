<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Sample</title>
</head>

<body>
    <h1>Service Worker Sample</h1>
    <div id="status">Registering Service Worker...</div>

    <div style="margin: 20px 0;">
        <button id="btn-root" style="margin: 5px; padding: 10px 20px;">Request /</button>
        <button id="btn-hello" style="margin: 5px; padding: 10px 20px;">Request /hello</button>
        <button id="btn-profile" style="margin: 5px; padding: 10px 20px;">Request /profile</button>
        <button id="btn-404" style="margin: 5px; padding: 10px 20px;">Request /404</button>
    </div>

    <div style="margin: 20px 0;">
        <input type="text" id="custom-path" placeholder="/custom/path" style="padding: 10px; width: 200px; font-size: 14px;">
        <button id="btn-custom" style="margin: 5px; padding: 10px 20px;">Request Custom Path</button>
    </div>

    <div id="content"></div>

    <script>
        // Detect super reload and handle it
        document.addEventListener('DOMContentLoaded', () => {
            const navigationEntry = performance.getEntriesByType('navigation')[0];
            const isReload = navigationEntry && navigationEntry.type === 'reload';
            const noController = !navigator.serviceWorker.controller;

            if (isReload && noController) {
                console.warn('[Super Reload Detected] Service Worker was bypassed. Reloading normally...');
                alert('Super reload detected. Service Worker was bypassed.\nReloading normally to activate Service Worker...');
                location.reload();
                return;
            }
        });

        // Function to fetch and display response
        function fetchAndDisplay(path) {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = '<p>Loading...</p>';

            fetch(path)
                .then(response => {
                    const status = response.status;
                    const statusText = response.statusText || '';
                    const headers = {};
                    for (const [key, value] of response.headers.entries()) {
                        headers[key] = value;
                    }
                    return response.text().then(data => ({ status, statusText, headers, data }));
                })
                .then(({ status, statusText, headers, data }) => {
                    console.log('Response from Service Worker:', status, headers, data);
                    let prettyData;
                    try {
                        prettyData = JSON.stringify(JSON.parse(data), null, 2);
                    } catch (e) {
                        prettyData = data; // If not JSON, display as is
                    }
                    const statusColor = status >= 200 && status < 300 ? 'green' : status >= 400 ? 'red' : 'orange';
                    const headersHtml = Object.entries(headers)
                        .map(([key, value]) => '<tr><td style="padding: 2px 10px 2px 0; font-weight: bold;">' + key + '</td><td>' + value + '</td></tr>')
                        .join('');
                    contentDiv.innerHTML =
                        '<h2>Response from ' + path + ':</h2>' +
                        '<p><strong>Status:</strong> <span style="color: ' + statusColor + ';">' + status + ' ' + statusText + '</span></p>' +
                        '<details style="margin: 10px 0;"><summary style="cursor: pointer;"><strong>Headers</strong></summary><table style="margin: 10px 0; font-size: 14px;">' + headersHtml + '</table></details>' +
                        '<p><strong>Body:</strong></p><pre>' + prettyData + '</pre>';
                })
                .catch(error => {
                    console.error('Error:', error);
                    contentDiv.innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
                });
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                    document.getElementById('status').textContent = 'Service Worker registered';

                    // Wait for Service Worker to become active
                    return navigator.serviceWorker.ready;
                })
                .then(() => {
                    console.log('Service Worker is ready');
                    document.getElementById('status').textContent = 'Service Worker ready! Click a button to make a request.';

                    // Setup button event listeners
                    document.getElementById('btn-root').addEventListener('click', () => fetchAndDisplay('/'));
                    document.getElementById('btn-hello').addEventListener('click', () => fetchAndDisplay('/hello'));
                    document.getElementById('btn-profile').addEventListener('click', () => fetchAndDisplay('/profile'));
                    document.getElementById('btn-404').addEventListener('click', () => fetchAndDisplay('/404'));
                    document.getElementById('btn-custom').addEventListener('click', () => {
                        const path = document.getElementById('custom-path').value.trim();
                        if (path) {
                            fetchAndDisplay(path.startsWith('/') ? path : '/' + path);
                        }
                    });
                    document.getElementById('custom-path').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            document.getElementById('btn-custom').click();
                        }
                    });

                    // Enable buttons
                    document.getElementById('btn-root').disabled = false;
                    document.getElementById('btn-hello').disabled = false;
                    document.getElementById('btn-profile').disabled = false;
                    document.getElementById('btn-404').disabled = false;
                    document.getElementById('btn-custom').disabled = false;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('status').textContent = 'Error: ' + error.message;
                });

            // Disable buttons initially
            document.getElementById('btn-root').disabled = true;
            document.getElementById('btn-hello').disabled = true;
            document.getElementById('btn-profile').disabled = true;
            document.getElementById('btn-404').disabled = true;
            document.getElementById('btn-custom').disabled = true;
        } else {
            document.getElementById('status').textContent = 'Service Worker is not supported';
        }
    </script>
</body>

</html>